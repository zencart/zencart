// -----
// Part of the "Product Options Stock Manager" plugin by Cindy Merkin
// Copyright (c) 2014-2024 Vinos de Frutas Tropicales
//
// Last updated: v6.0.0
//
$(function(){attributeWrapper===wrapperAttribsOptions&&($(attributeWrapper).each(function(){$(this).nextUntil(wrapperAttribsOptions).addBack().wrapAll('<div class="posm-wrapper"></div>')}),attributeWrapper=".posm-wrapper");let n=null;let o=0;if($(attributeWrapper).each(function(){let t=!1;if(0<$(this).find(inputTypes).length){let e=$(this).find(inputTypesFirst).attr("name").match(/\d+/g);-1===ignoreOptionsList.indexOf(Number(e[0]))&&(null===n?(o=e,$(this).addClass("posm-active"),n=$(this),t=!0,isSingleOption||(0<$(this).find("select").length?$(this).find("option:selected").prop("selected",!1):$(this).find('input[type="radio"]:checked').prop("checked",!1))):($(this).removeClass("posm-active"),$(this).find(inputTypesFirst).each(function(){e=$(this).attr("name").match(/\d+/g),-1===ignoreOptionsList.indexOf(Number(e[0]))&&$(this).prop("disabled",!0)})),isSingleOption||(0<$(this).find("select").length?$(this).find("option:selected").prop("selected",!1):($(this).find('input[type="radio"]:checked').prop("checked",!1),t||($(this).children().children().not(optionNameSelector).hide(),$(this).find(attribImgSelector).hide(),$(this).find(optionNameSelector).append(' <span class="posm-prev-choices">'+radioButtonChoose+"</span>")))))}}),insertPleaseChoose){let t=!1;$(wrapperAttribsOptions+" select").each(function(){var e=$(this).attr("name").match(/\d+/g);-1===ignoreOptionsList.indexOf(Number(e[0]))&&(t?$(this).prepend($('<option value="0" selected="selected">'+pleaseChooseNextText+"</option>")):(t=!0,$(this).prepend($('<option value="0" selected="selected">'+pleaseChooseText+"</option>"))))})}"function"==typeof console.log&&console.log("firstGroup optionID: "+o),!1===isSingleOption&&($(n).find('input[type="radio"]:checked').prop("checked",!1),$(n).find("select :selected").prop("selected",!1),$(n).find("select option:first").prop("selected",!0),$(document).on("click",'#productAttributes option:selected, #productAttributes input[type="radio"]:checked',function(){$(this).trigger("change")})),zcJS.ajax({url:"ajax.php?act=ajaxOptionsStockDependencies&method=availableOptionValues",data:{products_id:$('input[name="products_id"]').val(),options_id:o,selected_values:"",calling_page:"'"+callingPage+"'",calling_pid:callingPid}}).done(function(s){if(!0===s.error)$("#posm_message").html(s.error_message),window.console&&"function"==typeof console.log&&console.log(s.error_message);else{lastSelection=s.last_selection,$(n).children().children().not(optionNameSelector).hide();for(let o=0,e=s.option_values.length;o<e;o++){let e=$(n).find("select option[value="+s.option_values[o].options_values_id+"]");0!==e.length&&e.prop("disabled",!1);let t=$(n).find('input[type="radio"][value="'+s.option_values[o].options_values_id+'"]');lastSelection&&(outOfStockMessage=0<s.option_values[o].quantity?(outOfStockClass="in-stock",inStockMessage.replace("%u",s.option_values[o].quantity)):(outOfStockClass="no-stock",s.option_values[o].oos_message),0!==e.length?(showModelNum&&0!==s.option_values[o].model.length&&e.append(' <span class="posm-model-num">['+s.option_values[o].model+"]</span>"),""!==outOfStockMessage&&e.append(' <span class="posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==s.option_values[o].extra_info&&e.append(' <span class="posm-stock-msg">'+s.option_values[o].extra_info+"</span>"),e.removeClass(),e.addClass(outOfStockClass)):0!==t.length&&(showModelNum&&0!==s.option_values[o].model.length&&t.next().append(' <span class="posm-model-num">['+s.option_values[o].model+"]</span>"),""!==outOfStockMessage&&t.next().append(' <span class="'+outOfStockClass+' posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==s.option_values[o].extra_info&&t.next().append(' <span class="posm-stock-msg">'+s.option_values[o].extra_info+"</span>")),allowCheckout||"no-stock"!==outOfStockClass||(0!==e.length?(e.prop("disabled",!0),e.prop("selected",!1)):0!==t.length&&(t.prop("disabled",!0),t.prop("checked",!1)))),$(n).show().children().children().show()}}});let i;$(document).on("change",'#productAttributes select, #productAttributes input[type="radio"]',function(e){var t=$(e.target);$(".posm-error").remove();e=e.target.value;window.console&&"function"==typeof console.log&&console.log("Changed value: "+e),o=0;t=$(t).closest(attributeWrapper);if($(t).nextAll(attributeWrapper).each(function(){var e,t;0!==$(this).find(inputTypes).length&&($(this).removeClass("posm-active"),e=$(this).find(inputTypes),0<$(e).length&&(t=$(e).attr("name").match(/\d+/g),-1===ignoreOptionsList.indexOf(Number(t[0]))&&($(this).find(".posm-prev-choices").remove(),0===o?(i=$(this),o=t):$(e).prop("disabled",!0),$(e).is("select")?($(e).find("option:selected").prop("selected",!1),$(e).find("option:first").prop("selected",!0)):($(e).prop("checked",!1),o!==t&&($(this).find(optionNameSelector).append(' <span class="posm-prev-choices">'+radioButtonChoose+"</span>"),$(this).children().children().not(optionNameSelector).hide(),$(this).find(attribImgSelector).hide())))))}),window.console&&"function"==typeof console.log&&console.log("nextOptionGroup optionID: "+o),0!==o){let t="";$("#productAttributes "+attributeWrapper+".posm-active").each(function(){var e=$(this).find('select option:selected, input[type="radio"]:checked');0<$(e).length&&(""!==t&&(t+=","),$(e).is("option")?t+=$(e).parent("select").attr("name").match(/\d+/g):t+=$(e).attr("name").match(/\d+/g),t+=":"+$(e).val())}),window.console&&"function"==typeof console.log&&console.log("currentSelections: ("+t+")"),zcJS.ajax({url:"ajax.php?act=ajaxOptionsStockDependencies&method=availableOptionValues",data:{products_id:$('input[name="products_id"]').val(),options_id:o,selected_values:"'"+t+"'",calling_page:"'"+callingPage+"'",calling_pid:callingPid}}).done(function(s){if(!0===s.error)$("#posm_message").html(s.error_message),window.console&&"function"==typeof console.log&&console.log(s.error_message);else{lastSelection=s.last_selection,$(i).addClass("posm-active"),$(i).children().children().not(optionNameSelector).hide(),$(i).find("select option").hide(),$(i).find("select option").prop("disabled",!0);let e=!1;0===$(i).find(attribImgSelector+' > input[type="radio"]').length?(e=!0,$(i).find('input[type="radio"]').nextUntil('input[type="radio"]').addBack().hide()):$(i).find(attribImgSelector).hide(),$(i).find(inputTypes).each(function(){$(this).prop("disabled",!1)}),$(i).find(".posm-stock-msg, .posm-model-num").each(function(){$(this).remove()});for(let o=0,e=s.option_values.length;o<e;o++){let e=$(i).find("select option[value="+s.option_values[o].options_values_id+"]"),t=$(i).find('input[type="radio"][value="'+s.option_values[o].options_values_id+'"]');lastSelection&&(outOfStockMessage=0<s.option_values[o].quantity?(outOfStockClass="in-stock",inStockMessage.replace("%u",s.option_values[o].quantity)):(outOfStockClass="no-stock",s.option_values[o].oos_message),0!==e.length&&(e.prop("disabled",!1),showModelNum&&0!==s.option_values[o].model.length&&e.append(' <span class="posm-model-num">['+s.option_values[o].model+"]</span>"),""!==outOfStockMessage&&e.append(' <span class="posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==s.option_values[o].extra_info&&e.append(' <span class="posm-stock-msg">'+s.option_values[o].extra_info+"</span>"),e.removeClass(),e.addClass(outOfStockClass)),0!==t.length&&(showModelNum&&0!==s.option_values[o].model.length&&t.next().append(' <span class="posm-model-num">['+s.option_values[o].model+"]</span>"),""!==outOfStockMessage&&t.next().append(' <span class="'+outOfStockClass+' posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==s.option_values[o].extra_info&&t.next().append(' <span class="posm-stock-msg">'+s.option_values[o].extra_info+"</span>")),allowCheckout||"no-stock"!==outOfStockClass||(0!==e.length?(e.prop("disabled",!0),e.prop("selected",!1)):0!==t.length&&(t.prop("disabled",!0),t.prop("checked",!1)))),0!==e.length?(e.closest(attributeWrapper).show().children().children().show(),e.prop("disabled",!1),e.show()):0!==t.length&&(t.closest(attributeWrapper).show().children().children().show(),(t.parent().hasClass(attribImgSelector.substring(1,attribImgSelector.length))?t.parent():t.nextUntil('input[type="radio"]').addBack()).show())}e&&$(i).find(attribImgSelector).show()}0!==s.extra_functions.length&&("function"==typeof console.log&&console.log("Processing extra functions..."),$.each(s.extra_functions,function(e,t){window[e](t)}))})}}),$(document).on("submit",'form[name="cart_quantity"]',function(e){let t=!0;return $(".posm-error").remove(),$(attributeWrapper+".posm-active").each(function(){var e;0<$(this).find(inputTypes).length&&(0!==$(this).find('option:selected, input[type="radio"]:checked').length&&0===$(this).find("option[value=0]:selected").length||(t=!1,e=$(this).find(optionNameSelector).text().replace(/:/g,"").replace(/[&<"']/g,function(e){switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return e}}),$(this).find(optionNameSelector).after('<span class="posm-error">'+noSelectionText+e+"</span>")))}),!1===t&&(e.stopImmediatePropagation(),e.preventDefault(),$("html, body").stop().animate({scrollTop:$(this).find(optionNameSelector).parent().offset().top},1e3)),t})});